<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./assets/css/admin/admin.css">
    <title>Trang Admin</title>
</head>
<body>
    <div class="admin_input-products">
        <h2>Nhập Sản Phẩm</h2>
        <form id="productForm">
            <!-- Loại bỏ trường ID -->
            <label for="name">Tên Sản Phẩm:</label>
            <input type="text" id="name" name="name" required>
        
            <label for="description">Mô Tả:</label>
            <textarea id="description" name="description" required></textarea>
        
            <label for="price">Giá:</label>
            <input type="number" id="price" name="price" required min="0">
        
            <label for="image">Hình Ảnh:</label>
            <input type="file" id="image" name="image" accept="image/*" required>
        
            <label for="brand">Hãng:</label>
            <input type="text" id="brand" name="brand" required>
        
            <label for="type">Loại:</label>
<select id="type" name="type" required>
    <option value="Quạt lửng">Quạt Lửng</option>
    <option value="Quạt trần">Quạt Trần</option>
    <option value="Quạt hơi nước">Quạt Hơi Nước</option>
</select>

        
            <label for="power">Công Suất:</label>
            <input type="number" id="power" name="power" required min="0">
        
            <label for="speed">Tốc Độ:</label>
            <input type="number" id="speed" name="speed" required min="0">
        
            <label for="highlight">Nổi Bật:</label>
            <textarea id="highlight" name="highlight" required></textarea>
        
            <label for="origin">Xuất Xứ:</label>
            <input type="text" id="origin" name="origin" required>
        
            <input type="submit" value="Thêm Sản Phẩm">
        </form>        
    </div>

    <div id="message"></div>
    <div id="notification"></div>

    <div class="admin_status-products">
        <div class="phanloai">
            <ul class="phanloai_sp">
                <li><a href="#" onclick="filterProducts('Quạt trần'); return false;">Quạt trần</a></li>
                <li class="li-space"><a href="#" onclick="filterProducts('Quạt lửng'); return false;">Quạt lửng</a></li>
                <li class="li-space"><a href="#" onclick="filterProducts('Quạt hơi nước'); return false;">Quạt hơi nước</a></li>
                <li class="li-space"><a href="#" onclick="filterProducts(''); return false;">Tất cả sản phẩm</a></li>
            </ul>
        </div>        
        <h3>Danh Sách Sản Phẩm</h3>
        <table id="productTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Tên</th>
                    <th>Mô Tả</th>
                    <th>Giá</th>
                    <th>Hình Ảnh</th>
                    <th>Hãng</th>
                    <th>Loại</th>
                    <th>Hành Động</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        <div class="pagination">
            <button id="prevPage" style="display:none;">&#10094;</button>
            <span id="pageInfo"></span>
            <button id="nextPage" style="display:none;">&#10095;</button>
        </div>
    </div>

    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <h4>Sửa Sản Phẩm</h4>
            <form id="editProductForm" action="update_product.php" method="POST" enctype="multipart/form-data">
                <div class="display_product">
                    <div class="left-section">
                        <label for="editId">ID Sản Phẩm:</label>
                        <input type="text" id="editId" name="editId" readonly>
        
                        <label for="editName">Tên Sản Phẩm:</label>
                        <input type="text" id="editName" name="editName" required>
        
                        <label for="editDescription">Mô Tả:</label>
                        <textarea id="editDescription" name="editDescription" required></textarea>
        
                        <label for="editPrice">Giá:</label>
                        <input type="number" id="editPrice" name="editPrice" required min="0">
        
                        <label for="editImage">Hình Ảnh:</label>
                        <input type="file" id="editImage" name="editImage" accept="image/*">
                    </div>
        
                    <div class="right-section">
                        <label for="editBrand">Thương Hiệu:</label>
                        <input type="text" id="editBrand" name="editBrand">
        
                        <label for="editType">Loại:</label>
                        <select id="editType" name="editType">
                            <option value="Quạt lửng">Quạt Lửng</option>
                            <option value="Quạt trần">Quạt Trần</option>
                            <option value="Quạt hơi nước">Quạt Hơi Nước</option>
                        </select>
                        
        
                        <label for="editPower">Công Suất:</label>
                        <input type="number" id="editPower" name="editPower" min="1">
        
                        <label for="editSpeed">Tốc Độ:</label>
                        <input type="number" id="editSpeed" name="editSpeed" min="1">
            
                        <label for="editHighlight">Nổi Bật:</label>
                        <textarea id="editHighlight" name="editHighlight"></textarea>
            
                        <label for="editOrigin">Xuất Xứ:</label>
                        <input type="text" id="editOrigin" name="editOrigin">
                    </div>
                </div>
    
                <div class="button-distance">
                    <input type="submit" value="Cập Nhật">
                    <button type="button" onclick="closeEditModal()">Hủy</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirmDeleteModal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <h4>Bạn có chắc chắn muốn xóa sản phẩm này?</h4>
            <button id="confirmDeleteBtn">Xóa</button>
            <button id="cancelDeleteBtn">Hủy</button>
        </div>
    </div>

    <div id="toast" class="toast">Sản phẩm đã được thêm thành công!</div>

    <script>
        let currentPage = 1;
        const productsPerPage = 5;
        let products = [];
        let productIdToDelete = null;
        let filteredProducts = products;
        document.getElementById('productForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(this);

            fetch('dulieu/insert_product.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(data => {
                document.getElementById('message').innerHTML = data;
                this.reset();
                loadProducts();
                showToast('Sản phẩm đã được thêm thành công!');
            })
            .catch(error => console.error('Error:', error));
        });

        function loadProducts() {
            fetch('dulieu/data.js')
                .then(response => response.text())
                .then(data => {
                    products = JSON.parse(data.replace('var products = ', '').slice(0, -1));
                    filteredProducts = products;
                    displayProducts();
                })
                .catch(error => console.error('Error loading products:', error));
        }

        function displayProducts() {
    const tbody = document.querySelector('#productTable tbody');
    tbody.innerHTML = '';

    // Sử dụng filteredProducts thay vì products
    const startIndex = (currentPage - 1) * productsPerPage;
    const endIndex = Math.min(startIndex + productsPerPage, filteredProducts.length);
    const paginatedProducts = filteredProducts.slice(startIndex, endIndex);

    paginatedProducts.forEach(product => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${product.id}</td>
            <td class="name">${product.name}</td>
            <td class="description">${product.description}</td>
            <td>${product.price}</td>
            <td><img src="/testnua/assets/Images/products/${product.image}" alt="${product.name}" width="100"></td>
            <td>${product.brand}</td>
            <td>${product.type}</td>
            <td>
                <button class="edit-btn" onclick="editProduct('${product.id}')">Sửa</button>
                <button class="delete-btn" onclick="deleteProduct('${product.id}')">Xóa</button>
            </td>
        `;
        tbody.appendChild(row);
    });

    updatePagination();
}


        function updatePagination() {
            const totalPages = Math.ceil(products.length / productsPerPage);
            document.getElementById('pageInfo').textContent = `Trang ${currentPage} / ${totalPages}`;
            document.getElementById('prevPage').style.display = currentPage > 1 ? 'inline' : 'none';
            document.getElementById('nextPage').style.display = currentPage < totalPages ? 'inline' : 'none';
        }

        document.getElementById('prevPage').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                displayProducts();
            }
        });

        document.getElementById('nextPage').addEventListener('click', () => {
            const totalPages = Math.ceil(products.length / productsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                displayProducts();
            }
        });

        function deleteProduct(productId) {
            productIdToDelete = productId;
            document.getElementById('confirmDeleteModal').style.display = 'flex';
        }

        document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
            if (productIdToDelete) {
                fetch('dulieu/delete_product.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id: productIdToDelete })
                })
                .then(response => response.text())
                .then(data => {
                    showToast('Sản phẩm đã được xóa thành công!');
                    loadProducts();
                    closeModal();
                })
                .catch(error => console.error('Error:', error));
            }
        });

        document.getElementById('cancelDeleteBtn').addEventListener('click', closeModal);

        function closeModal() {
            document.getElementById('confirmDeleteModal').style.display = 'none';
            productIdToDelete = null;
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        window.onload = loadProducts;

        function editProduct(productId) {
    fetch('dulieu/data.js')
        .then(response => response.text())
        .then(data => {
            const products = JSON.parse(data.replace('var products = ', '').slice(0, -1));
            const product = products.find(p => p.id == productId);

            if (product) {
                const editFields = [
                    { field: 'editId', value: product.id },
                    { field: 'editName', value: product.name },
                    { field: 'editDescription', value: product.description },
                    { field: 'editPrice', value: product.price.toString().replace(/\./g, '').replace(/,/g, '.') }, // Chuyển đổi giá
                    { field: 'editBrand', value: product.brand },
                    { field: 'editType', value: product.type },
                    { field: 'editPower', value: product.power },
                    { field: 'editSpeed', value: product.speed },
                    { field: 'editHighlight', value: product.highlight },
                    { field: 'editOrigin', value: product.origin }
                ];

                editFields.forEach(({ field, value }) => {
                    const element = document.getElementById(field);
                    if (element) {
                        element.value = value;
                    }
                });

                document.getElementById('editProductModal').style.display = 'flex';
            }
        })
        .catch(error => console.error('Error:', error));
}

document.getElementById('editProductForm').addEventListener('submit', function(event) {
    event.preventDefault();
    const formData = new FormData(this);

    // Debug: Kiểm tra nội dung của formData
    for (let pair of formData.entries()) {
        console.log(pair[0] + ', ' + pair[1]);
    }

    fetch('dulieu/update_product.php', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok: ' + response.statusText);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast(data.success);
            loadProducts();  // Đảm bảo loadProducts() được định nghĩa để tải lại sản phẩm
            closeEditModal();
        } else {
            showToast(data.error || 'Đã xảy ra lỗi khi cập nhật sản phẩm.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Đã xảy ra lỗi khi cập nhật sản phẩm.');
    });
});

function closeEditModal() {
    document.getElementById('editProductModal').style.display = 'none';
}

function filterProducts(selectedType = '') {
    filteredProducts = products.filter(product => {
        return selectedType ? product.type === selectedType : true; // Lọc theo loại nếu có, nếu không thì lấy tất cả sản phẩm
    });

    currentPage = 1; // Reset về trang đầu khi lọc
    displayProducts(); // Hiển thị sản phẩm đã lọc
}


    </script>
</body>
</html>